<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Thawk ü¶£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,100' rel='stylesheet' type='text/css'>
</head>
<style>
  body{
    /* background-color: #a400f6; */
    font-family: 'Roboto', sans-serif;
  }
  
  .container{
    /*border:1px solid white;*/
    width: 600px;
    height: 350px;
    position: absolute;
    top:50%;
    left:50%;
    transform: translate(-50%, -50%);
    display: inline-flex; 
  }

  .backbox{  
    background-color: #002765;
    width: 100%;
    height: 80%;
    position: absolute;
    transform: translate(0,-50%);
    top:50%;
    display: inline-flex;
    border-radius: 20px;
  }
  
  .frontbox {
    background-color: white;
    border-radius: 20px;
    height: 100%;
    width: 50%;
    z-index: 10;
    position: absolute;
    right: 0;
    margin-right: 3%;
    margin-left: 3%;
    transition: right 0.8s ease-in-out;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
  }
  
  .moving{
    right:45%;
  }
  
  .loginMsg, .signupMsg{
    width: 50%;
    height: 100%;
    font-size: 15px;
    box-sizing: border-box;
    border-radius: 20px;
  }
  
  .loginMsg .title,
  .signupMsg .title{
    font-weight: 300;
    font-size: 23px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Added dark shadow */
  }
  
  .loginMsg p,
  .signupMsg p {
    font-weight: 100;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Added dark shadow */
  }
  
  .textcontent{
    color:white;
    margin-top:65px;
    margin-left: 12%;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Added dark shadow */
  }
  
  .loginMsg button,
  .signupMsg button {
    background-color: #0086ff; /* #404040; */
    border: 2px solid white;
    border-radius: 10px;
    color:white;
    font-size: 12px;
    box-sizing: content-box;
    font-weight: 300;
    padding:10px;
    margin-top: 20px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Added dark shadow */
  }
  
  /* front box content*/
  .login, .signup{
    padding: 20px;
    text-align: center;
  }
  
  .login h2,
  .signup h2 {
    color: #0086ff; /* #35B729; */
    font-size:22px;
  }
  
  .inputbox{
    margin-top:30px; 
  }
  .login input, 
  .signup input {
    display: block;
    width: 100%;
    height: 40px;
    background-color: #f2f2f2;
    border: none;
    margin-bottom:20px;
    font-size: 12px;
  }
  
  .login button,
  .signup button{
    background-color: #0086ff; /* #35B729; */
    border: none;
    color:white;
    font-size: 12px;
    font-weight: 300;
    box-sizing: content-box;
    padding:10px;
    border-radius: 10px;
    width: 60px;
    position: absolute;
    right:30px;
    bottom: 30px;
    cursor: pointer;
  }
  
  /* Fade In & Out*/
  .login p {
    cursor: pointer;
    color:#404040;
    font-size:15px;
  }
  
  .loginMsg, .signupMsg{
    /*opacity: 1;*/
    transition: opacity .8s ease-in-out;
  }
  
  .visibility{
    opacity: 0;
  }
  
  .hide{
    display: none;
  }

  .login-logo {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    max-width: none;
    max-height: none;
    border-radius: 0;
    z-index: -1;
  }

  .login-logo-bottom {
    width: 1150px;
    position: absolute;
    top: -400px;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 20px;
  }

  .welcome-icon {
    position: fixed;
    bottom: 20px;
    left: 20px; /* Move to the left */
    width: 50px;
    height: 50px;
    background-color: #0086ff;
    color: white;
    font-size: 24px;
    border-radius: 50%; /* Makes it round */
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: transform 0.2s ease-in-out;
}

.help-icon:hover {
    transform: scale(1.1); /* Slight hover effect */
}

  .help-icon {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background-color: #0086ff;
    color: white;
    font-size: 24px;
    border-radius: 50%; /* Makes it round */
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: transform 0.2s ease-in-out;
}

.help-icon:hover {
    transform: scale(1.1); /* Slight zoom effect */
}

.video-container {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  height: 0;
  overflow: hidden;
  max-width: 100%;
  /* background: black; */
}
.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

</style>
  
<body>

  <div class="container">
    <img src="logo2.png" class="login-logo" alt="Twark Chat Logo"> 
    <!-- <img src="https://mammothon.celestia.org/images/bg.png" class="login-logo" alt="Twark Chat Logo">  -->
    <!-- logo.jpg -->
    <div class="backbox">
      
      <div class="loginMsg" style="background-image: url('thawk1.jpg'); background-size: 100% 100%; background-repeat: no-repeat;">
        <div class="textcontent">
          <button id="switch1"><strong>Sign Up</strong></button>
          <br><br>
          <p><strong>Sign up to Thawk chat.</strong></p>
          <p class="title"><strong>Don't have an account?</strong></p>
        </div>
      </div>
      
      <div class="signupMsg visibility" style="background-image: url('thawk1.jpg'); background-size: 100% 100%; background-repeat: no-repeat;">
        <div class="textcontent">
          <button id="switch2"><strong>LOG IN</strong></button>
          <br><br>
          <p><strong>Log in to Thawk chat.</strong></p>
          <p class="title"><strong>Have an account?</strong></p>
        </div>
      </div>
    
    </div>

    <div class="frontbox">
      <div class="login">
        <h2>LOG IN</h2>
        <div class="inputbox">
          <input type="text" id="login_cosmos" name="login_cosmos" placeholder="  COSMOS ADDRESS">
          <input type="password" id="login_password" name="login_password" placeholder="  PASSWORD">
        </div>
        <p>THERE IS NO PASSWORD RECOVERY OPTION</p>
        <button onclick="login()">LOG IN</button>
      </div>
      <div id="resultElement"></div>

      <div class="signup hide">
        <h2>SIGN UP</h2>
        <div class="inputbox">
            <input type="text" id="name" name="name" placeholder="  NAME">
            <input type="text" id="cosmos" name="cosmos" placeholder="  COSMOS ADDRESS">
            <input type="password" id="password" name="password" placeholder="  PASSWORD MINIMUM 8 CHARACTERS">
        </div>
        <button onclick="signup()">SIGN UP</button>
        <br>
        <h5 id="result"></h5>
    </div>

    </div>
  </div>

  <div class="welcome-icon" data-bs-toggle="modal" data-bs-target="#WelcomeModal">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M17 10.5V7c0-.83-.67-1.5-1.5-1.5h-10C4.67 5.5 4 6.17 4 7v10c0 .83.67 1.5 1.5 1.5h10c.83 0 1.5-.67 1.5-1.5v-3.5l4 4v-11l-4 4z"/>
    </svg>
  </div>
  
  <div class="modal fade" id="WelcomeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Thawk Walkthrough!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <div class="video-container">
            <iframe width="560" height="315" src="thawk_walkthrough.mp4" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="help-icon" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
    ‚ùì
  </div>
  
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Welcome to Thawk!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          You‚Äôve entered the land of giants, where conversations roar like mammoths on the move! In Thawk, your voice is powerful, and your presence immense‚Äîlet‚Äôs get you signed up and ready to thunder.
          <br><br>
          <strong>How to Sign Up or Log In</strong><br><br>
          1. Grab your Cosmos address‚Äîyour key to unlock the vast world of Thawk.<br><br>
          2. Enter your Cosmos address in the box above.<br><br>
          3. Smash the Sign Up or Log In button, and step into the giant conversation with the herd!<br>
          <br><br>
          <strong>Anonymity as Big as a Mammoth</strong>
          <br>
          At Thawk, we prioritize your privacy and security just as much as we do our epic conversations. By signing up with your Cosmos address, we ensure that there is no connection to your personal details, keeping you completely anonymous and separating your personal data from the platform. All you need to start chatting is a wallet address, which can be verified through Keplr.
          <br><br>
          Your wallet address is the only link to your chats. There is no password recovery option, so keep your password safe and secure. If you lose it, you lose access to your chats linked to that wallet.
          <br><br>
          Once you leave the conversation, your chats vanish like mammoth footprints in the snow‚Äîno history, no trace‚Äîkeeping you free and anonymous in the vast expanse of Thawk.
          <br><br>
          So roar with confidence, knowing your identity stays as hidden as the giants of old.
          <br>
          Welcome to the Thawk herd!
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
          <!-- <button type="button" class="btn btn-primary">I Understand</button> -->
        </div>
      </div>
    </div>
  </div>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>

</html>


<script src="https://cdn.jsdelivr.net/npm/pocketbase/dist/pocketbase.umd.js"></script>

  <script>
    var $loginMsg = $('.loginMsg'),
    $login = $('.login'),
    $signupMsg = $('.signupMsg'),
    $signup = $('.signup'),
    $frontbox = $('.frontbox');

    $('#switch1').on('click', function() {
      $loginMsg.toggleClass("visibility");
      $frontbox.addClass("moving");
      $signupMsg.toggleClass("visibility");

      $signup.toggleClass('hide');
      $login.toggleClass('hide');
    })

    $('#switch2').on('click', function() {
      $loginMsg.toggleClass("visibility");
      $frontbox.removeClass("moving");
      $signupMsg.toggleClass("visibility");

      $signup.toggleClass('hide');
      $login.toggleClass('hide');
    })

    setTimeout(function(){
      $('#switch1').click()
    },500)

    setTimeout(function(){
      $('#switch2').click()
    },500)

    function showHelp() {
      alert("How can we assist you?");
    }

    //const pb = new PocketBase('http://127.0.0.1:8090');
    const pb = new PocketBase('https://thawk.xyz/pocketbase');

    const resultElement = document.getElementById("result");
    
    async function login() {
      try {
        const cosmosAddress = document.getElementById("login_cosmos").value.trim();
        const password = document.getElementById('login_password').value.trim();
        const email = `${cosmosAddress}@twark.co.za`;

        try {
          const authData = await pb.collection('users').authWithPassword(email, password);
          if (authData) {
            // (not recommended for production due to XSS risks)
            localStorage.setItem('authToken', authData.token);

            // Then, when making API calls
            const token = localStorage.getItem('authToken');
            fetch('/api/endpoint', {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            window.location.href = `/chat/`;
            document.getElementById("resultElement").innerText = "‚úÖ Login successful!";
          } else {
            document.getElementById("resultElement").innerText = "‚ùå Login failed: No authentication data returned.";
          }
        } catch (error) {
          console.error("‚ùå Error during login:", error);
          document.getElementById("resultElement").innerText = "‚ùå Login failed: " + error.message;
        }
      } catch (error) {
        console.error("Error during login:", error);
        document.getElementById("resultElement").innerText = "‚ùå Login failed: " + error.message;
      }
    }

    async function signup() {
      resultElement.innerText = "‚úÖ Signing up...";

        const name = document.getElementById("name").value.trim();
        const cosmosAddress = document.getElementById("cosmos").value.trim();
        const password = document.getElementById('password').value.trim();

        // Verify wallet ownership first
        const isVerified = await verifyKeplrWallet(cosmosAddress);

        if (isVerified) {
          resultElement.innerText = "‚úÖ Keplr wallet verified! Proceeding with sign-up...";
            await createUser(name, cosmosAddress, password);
        } else {
            resultElement.innerText = "‚ùå Wallet verification failed!";
        }
    }

    async function verifyKeplrWallet(inputAddress) {
        const resultElement = document.getElementById("result");

        if (!window.keplr) {
          resultElement.innerText = "Keplr Wallet not detected. Please install the browser extension.";
            return false;
        }

        try {
            const chainId = "cosmoshub-4"; 
            await window.keplr.enable(chainId);
            const offlineSigner = window.getOfflineSigner(chainId);
            const accounts = await offlineSigner.getAccounts();
            const userAddress = accounts[0].address;

            if (inputAddress !== userAddress) {
                resultElement.innerText = "‚ùå Wallet address does not match the connected Keplr wallet!";
                return false;
            }

            const message = "Sign this message to verify wallet ownership";
            await window.keplr.signArbitrary(chainId, userAddress, message);

            resultElement.innerText = "‚úÖ Verified: Wallet ownership confirmed!";
            return true;
        } catch (error) {
            console.error("Keplr verification failed:", error);
            resultElement.innerText = "‚ùå Verification failed!";
            return false;
        }
    }

    async function createUser(name, address, password) {
      try {
        // Construct email address
        const email = `${address}@twark.co.za`;
    
        // Check if address already exists
        try {
          const existingRecord = await pb.collection('users').getFirstListItem(`email="${email}"`);
          if (existingRecord) {
            console.log("User with this email already exists:", existingRecord);
            resultElement.innerText = "‚ùå User with this email already exists.";
            return;
          }
        } catch (error) {
          if (error.data && error.data.code !== 404) {
            console.error("Error checking email:", error);
            resultElement.innerText = "‚ùå Error checking email.";
            return;
          }
        }
    
        const data = {
          "password": password,
          "passwordConfirm": password,
          "email": email,
          "address": address,
          "name": name,
          "emailVisibility": true,
          //"verified": true, // giving issue fix later use email ver for now 
        };
    
        const record = await pb.collection('users').create(data);

        const thawkdata = {
          "room_id": "ixdgmeiuk5wctq3",
          "user_id": record.id,
        };
        
        const thawk = await pb.collection('room_members').create(thawkdata);

        resultElement.innerText = "‚úÖ User created successfully";
        console.log("User created:", record);
        alert("‚úÖ User created successfully");
      } catch (error) {
        console.error("‚ùå Error creating user:", error);
        resultElement.innerText = "‚ùå Failed to create user.";
      }
    }

  </script>



</body>
</html>
